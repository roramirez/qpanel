<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Rodrigo RamÃ­rez Norambuena">
    <meta name="keyword" content="Dashboard, Panel, Queue, app_queue, Asterisk">

    <title>QPanel - {{name}}</title>

    <!-- Bootstrap core CSS -->
    <link href="{{url_for('static', filename='css/bootstrap.min.css')}}" rel="stylesheet">
    <!--external css-->
    <link href="{{url_for('static', filename='font-awesome/css/font-awesome.css')}}" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='lineicons/style.css')}}">

    <!-- Custom styles for this template -->
    <link href="{{url_for('static', filename='css/style.css')}}" rel="stylesheet">
    <link href="{{url_for('static', filename='css/style-responsive.css')}}" rel="stylesheet">

    <script src="{{url_for('static', filename='js/chart-master/Chart.js')}}"></script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
  <section id="container" class="sidebar-closed">
      <!--
          TOP BAR CONTENT & NOTIFICATIONS
        -->
      <!--header start-->
      <header class="header black-bg">
            <!--logo start-->
            <a href="{{url_for('.home')}}" class="logo"><img src="{{url_for('static', filename='img/logo_header.png')}}"></a>
            <!--logo end-->
            <div class="nav notify-row" id="top_menu">
            </div>
            <div class="top-menu">
                <ul class="nav pull-right top-menu">
                    {% include 'language_selector.html' %}
                </ul>
            </div>
        </header>
      <!--header end-->

      <!--sidebar start-->
      <aside>
      </aside>
      <!--sidebar end-->

      <!--main content start-->
      <section id="main-content" style="margin-left: 0px;">


          <section class="wrapper">
              <h3><i class="fa fa-angle-right"></i> {{name}} </h3>

              <div class="row">
                  <div class="col-lg-12 main-chart">

                      <div class="row"><!-- row general data-->
                        {% include 'row_general_data.html' %}
                      </div><!-- /row general data-->

                     <div class="row mt">
                    </div><!-- /row -->

                  <div class="col-md-12">
                      <div class="content-panel">
                          <table class="table table-striped table-advance table-hover" id="agents">
                            <h4><i class="fa fa-angle-right"></i> {{_('Agents')}}: <span id="total_agent" class="label label-default"></span></h4>
                            <hr>
                              <thead>
                              <tr>
                                  <th><i class="fa fa-user"></i> {{_('Name')}}</th>
                                  <th class="hidden-phone"><i class="fa fa-phone"></i> {{_('Interface')}}</th>
                                  <th><i class=" fa fa-question-circle "></i> {{_('Status')}}</th>
                                  <th><i class="fa fa-bookmark"></i> {{_('Calls')}}</th>
                                  <th><i class="fa fa-clock-o"></i> {{_('Last call at')}}</th>
                              </tr>
                              </thead>
                              <tbody>
                              {% for agent in data['members'] %}
                              <tr id="agent-{{format_id_agent(agent)}}">
                                  <td>{{ data['members'][agent]['Name'] }}</td>
                                  <td class="hidden-phone">{{ data['members'][agent]['StateInterface'] }}</td>
                                  <td id="status">
                                    <span class="label label-info label-mini state">
                                        {{str_status_agent(data['members'][agent]['Status']) }}
                                    </span>
                                    </td>
                                  <td id="calls">{{data['members'][agent]['CallsTaken'] }}</td>
                                  <td id="last_call">{{data['members'][agent]['LastCall'] }}</td>
                              </tr>
                              {% endfor %}
                              </tbody>
                          </table>
                      </div><!-- /content-panel -->
                  </div><!-- /col-md-12 -->

                  <div class="col-md-12">
                      <div class="content-panel">
                          <table class="table table-striped table-advance table-hover" id="callers">
                            <h4><i class="fa fa-angle-right"></i> {{_('Callers')}}: <span id="total_callers" class="label label-default"></span></h4>
                            <hr>
                              <thead>
                              <tr>
                                  <th><i class="fa fa-user"></i> {{_('Id Name')}}</th>
                                  <th class="hidden-phone"><i class="fa fa-phone"></i> {{_('Id Number')}}</th>
                                  <th><i class="fa fa-sort-numeric-asc"></i> {{_('Position')}}</th>
                                  <th><i class="fa fa-clock-o"></i> {{_('Wait')}}</th>
                              </tr>
                              </thead>
                              <tbody>
                              {% for caller in data['entries'] %}
                              <tr id="caller-{{data['entries'][caller]['Uniqueid']}}" data-uniqueid="{{data['entries'][caller]['Uniqueid']}}">
                                  <td>{{ data['entries'][caller]['CallerIDName'] }}</td>
                                  <td class="hidden-phone">{{ data['entries'][caller]['CallerIDNum'] }}</td>
                                  <td id="position">{{data['entries'][caller]['Position'] }}</td>
                                  <td id="wait">{{data['entries'][caller]['Wait'] }}</td>
                              </tr>
                              {% endfor %}
                              </tbody>
                          </table>
                      </div><!-- /content-panel -->
                  </div><!-- /col-md-12 -->

          </section>
      </section>

      <!--main content end-->
      {% include 'footer.html' %}
  </section>

    <!-- js placed at the end of the document so the pages load faster -->
    <script src="{{url_for('static', filename='js/bootstrap.min.js')}}"></script>
    <script src="{{url_for('static', filename='js/jquery.scrollTo.min.js')}}"></script>
    <script src="{{url_for('static', filename='js/jquery.nicescroll.js')}}" type="text/javascript"></script>

    <!--common script for all pages-->
    <script src="{{url_for('static', filename='js/common-scripts.js')}}"></script>

    <script type="application/javascript">
        $(document).ready(function () {
            getDataQueue(); //load data on page ready :)
            setInterval(function () {
                getDataQueue();
            }, {{ request_interval() }});
        });
        // parse data and put values on view
        function parseDataQueue(data){
          $('#answered').html(data.Completed);
          $('#abandoned').html(data.Abandoned);
          $('#incoming').html(data.Calls);
          $('#av_wait').html(parseInt(data.Holdtime).toString().toMMSS());
          $('#av_time').html(parseInt(data.TalkTime).toString().toMMSS());


          //agents
          var agents_ids = Array();
          for (agent in data.members) {
            tmp_agent_id_div = agent.replace(/\//g, '-');
            agent_id_div = tmp_agent_id_div.replace(/@/g, '_');
            $('#agent-' + agent_id_div + ' #calls').html(data.members[agent].CallsTaken)

            str_time_ago = ''
            if (data.members[agent].LastCall > 0) {
               str_time_ago = data.members[agent].LastCallAgo;
            }
            $('#agent-' + agent_id_div + ' #last_call').html(str_time_ago)

            $('#agent-' + agent_id_div + ' #status .state').html(data.members[agent].Status.toStrStatusAgent())
            addLabelDivStatusAgent($('#agent-' + agent_id_div + ' #status .state'));

            if (data.members[agent].Paused == true) {
                // reason pause introduced in https://goo.gl/Njm6H5
                var reason = '';
                if (data.members[agent].PausedReason){
                    reason = ": {reason}".format({'reason': data.members[agent].PausedReason});
                }

                $('#agent-' + agent_id_div + ' #status .pause').remove();
                $('#agent-'+ agent_id_div +' #status .state')
                   .after(' <span class="label label-success label-mini pause">{{_('paused')}}'+ reason +'</span>');
            } else {
                $('#agent-' + agent_id_div + ' #status .pause').remove();
            }


            var tr = '<tr id="agent-'+agent_id_div+'"><td>'
                        + data.members[agent].Name +'</td>'
                        + '<td>'+data.members[agent].StateInterface+'</td>'
                        + '<td id="status"> <span class="label label-info label-mini state">'
                        + data.members[agent].Status.toStrStatusAgent()
                        + '</span></td>'
                        + '<td>'+ data.members[agent].CallsTaken +'</td>'
                        + '<td></td></tr>';

            if ($('#agent-' + agent_id_div).length == 0) {
                if ($('#agents tbody tr:last').length > 0){
                    $('#agents tbody tr:last').after(tr);
                } else {
                    $('#agents tbody').append(tr);
                }
            }

            agents_ids.push(agent_id_div);
          }
          $('#total_agent').html("{total}".format({total:  Object.keys(data.members).length}));

          //callers
          var uniques_ids = Array();
          for (caller in data.entries) {
            c = data.entries[caller];

            if ($("[id='caller-"+ c.Uniqueid + "']").length == 0) {
              console.log('add:' + c.Uniqueid);

              var tr = '<tr id="caller-' + c.Uniqueid + '" data-uniqueid="' + c.Uniqueid + '"><td>'
                        + c.CallerIDName + '</td>'
                        + '<td>' + c.CallerIDNum + '</td>'
                        + '<td id="position">'  + c.Position + '</td>'
                        + '<td id="wait">' + c.WaitAgo + '</td></tr>'

              if ($('#callers tbody tr:last').length > 0){
                $('#callers tbody tr:last').after(tr);
              } else {
                $('#callers tbody').append(tr);
              }
            }

            $("[id='caller-"+ c.Uniqueid + "'] #wait").html(c.WaitAgo);
            $("[id='caller-"+ c.Uniqueid + "'] #position").html(c.Position);
            uniques_ids.push(c.Uniqueid);
          }
          $.each($("[id^='caller-']"), function( index, value ) {
            uid = $(value).data('uniqueid');
            if (uniques_ids.indexOf(uid.toString()) == -1) {
              console.log('removed: ' + uid);
              $("[id='caller-"+ uid +"']").remove();
            }
          });
          $('#total_callers').html("{total}".format({total:  Object.keys(data.entries).length}));
          $.each($("[id^='agent-']"), function( index, value ) {
            uid = $(value).attr('id').substring(6);
            if (agents_ids.indexOf(uid.toString()) == -1) {
              console.log('removed: ' + uid);
              $("[id='agent-"+ uid +"']").remove();
            }
          });
        }

        function getDataQueue() {
            var result;
            var r = $.ajax({
                type: 'GET',
                url: '{{url_for('.queue', name=name+".json")}}'
            });
            r.done(function (response) {
                if (response) {
                    result = response.data;
                    parseDataQueue(result);
                }
            });
            r.fail(function (response) {
            });

            r.always(function () {
            });
        }
    </script>

    <script src="{{url_for('static', filename='js/utils.js')}}"></script>
    {% include 'i18n_js.html' %}
  </body>
</html>
